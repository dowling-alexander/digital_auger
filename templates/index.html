<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adeptus Mechanicus Network Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background for 40k feel */
            color: #e2e8f0; /* Light text */
        }
        .card {
            background-color: #2d3748; /* Darker card background */
            border: 1px solid #4a5568; /* Subtle border */
        }
        .alert-critical { background-color: #e53e3e; } /* Red */
        .alert-high { background-color: #dd6b20; }    /* Orange */
        .alert-medium { background-color: #ecc94b; }  /* Yellow */
        .alert-low { background-color: #48bb78; }     /* Green */
        .alert-info { background-color: #4299e1; }    /* Blue */
    </style>
</head>
<body class="bg-gray-900 p-4">
    <div class="max-w-5xl mx-auto bg-gray-800 p-6 rounded-lg shadow-2xl border border-gray-700">
        <h1 class="text-4xl font-extrabold text-red-500 mb-8 text-center uppercase tracking-wider">
            Network Auspex
        </h1>

        <div class="mb-8 text-center">
            <h2 class="text-2xl font-semibold text-gray-200 mb-2">Threat Assessment:</h2>
            <span id="threat-level" class="inline-block px-6 py-2 rounded-full text-xl font-bold uppercase shadow-lg bg-green-600 text-white">
                Machine Spirit Cohesion
            </span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="card p-4 rounded-lg shadow-md text-center">
                <h2 class="text-xl font-semibold mb-2 text-blue-400">Total Data Packets</h2>
                <p id="packet-count" class="text-4xl font-bold text-blue-200">{{ packet_count }}</p>
            </div>
            <div class="card p-4 rounded-lg shadow-md text-center">
                <h2 class="text-xl font-semibold mb-2 text-green-400">Active Servitors</h2>
                <p id="device-count" class="text-4xl font-bold text-green-200">{{ active_devices|length }}</p>
            </div>
            <!-- ARP Probes Detected card removed -->
        </div>

        <div class="mb-8">
            <h2 class="text-2xl font-semibold text-red-400 mb-4">Heresy & Intrusion Alerts</h2>
            {% if ids_alerts %}
            <ul id="ids-alerts-list" class="bg-gray-700 p-4 rounded-lg shadow-inner max-h-80 overflow-y-auto border border-red-700">
                {% for alert in ids_alerts | reverse %} {# Show most recent alerts first #}
                <li class="py-2 px-3 mb-2 rounded-md shadow-sm
                           {% if alert.severity == 'CRITICAL' %} alert-critical
                           {% elif alert.severity == 'HIGH' %} alert-high
                           {% elif alert.severity == 'MEDIUM' %} alert-medium
                           {% elif alert.severity == 'LOW' %} alert-low
                           {% else %} alert-info {% endif %}
                           text-white">
                    <span class="font-bold">[{{ alert.severity }}]</span>
                    <span class="font-medium">{{ alert.timestamp | int | timestamp_to_datetime }}</span>:
                    {{ alert.description }} (Rule: {{ alert.rule }})
                    {% if alert.source_ip %}<br><span class="text-sm opacity-80 pl-4">Source: {{ alert.source_ip }} ({{ alert.source_mac }})</span>{% endif %}
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-gray-400">No Heresy detected. Machine Spirit remains uncorrupted.</p>
            {% endif %}
        </div>

        <div class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-200 mb-4">Observed Active Servitors (Devices)</h2>
            {% if active_devices %}
            <ul id="active-devices-list" class="bg-gray-700 p-4 rounded-lg shadow-inner max-h-60 overflow-y-auto border border-gray-600">
                {% for ip, mac in active_devices %}
                <li class="py-1 border-b border-gray-600 last:border-b-0 text-gray-300">
                    <span class="font-medium text-blue-300">IP:</span> {{ ip }} | <span class="font-medium text-blue-300">MAC:</span> {{ mac }}
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-gray-400">No active servitors observed yet.</p>
            {% endif %}
        </div>

        <!-- Recent ARP Probes section removed -->
    </div>

    <script>
        // Function to format timestamp for JavaScript updates
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString(); // Formats to local date and time
        }

        // Function to fetch data and update the page dynamically
        async function updateData() {
            try {
                const response = await fetch('/data');
                const data = await response.json();

                if (data.error) {
                    console.error("Error fetching data:", data.error);
                    return;
                }

                document.getElementById('packet-count').innerText = data.packet_count;
                document.getElementById('device-count').innerText = data.active_devices.length;
                // document.getElementById('arp-count').innerText = data.arp_requests.length; // Removed

                // Update Active Devices List
                const activeDevicesList = document.getElementById('active-devices-list');
                activeDevicesList.innerHTML = ''; // Clear existing list
                if (data.active_devices.length > 0) {
                    // Sort devices by IP for consistent display
                    data.active_devices.sort((a, b) => {
                        const ipA = a[0].split('.').map(Number); // Access IP from tuple
                        const ipB = b[0].split('.').map(Number); // Access IP from tuple
                        for (let i = 0; i < 4; i++) {
                            if (ipA[i] !== ipB[i]) {
                                return ipA[i] - ipB[i];
                            }
                        }
                        return 0;
                    });
                    data.active_devices.forEach(device => {
                        const li = document.createElement('li');
                        li.className = 'py-1 border-b border-gray-600 last:border-b-0 text-gray-300';
                        li.innerHTML = `<span class="font-medium text-blue-300">IP:</span> ${device[0]} | <span class="font-medium text-blue-300">MAC:</span> ${device[1]}`; // Access tuple elements
                        activeDevicesList.appendChild(li);
                    });
                } else {
                    activeDevicesList.innerHTML = '<p class="text-gray-400">No active servitors observed yet.</p>';
                }

                // ARP Requests List update logic removed
                // const arpRequestsList = document.getElementById('arp-requests-list');
                // arpRequestsList.innerHTML = '';
                // if (data.arp_requests.length > 0) {
                //     data.arp_requests.slice().reverse().slice(0, 10).forEach(arp => {
                //         const li = document.createElement('li');
                //         li.className = 'py-1 border-b border-gray-600 last:border-b-0 text-gray-300';
                //         li.innerHTML = `<span class="font-medium text-purple-300">Time:</span> ${formatTimestamp(arp.timestamp)} | <span class="font-medium text-purple-300">Sender:</span> ${arp.sender_ip} (${arp.sender_mac}) | <span class="font-medium text-purple-300">Target:</span> ${arp.target_ip}`;
                //         arpRequestsList.appendChild(li);
                //     });
                // } else {
                //     arpRequestsList.innerHTML = '<p class="text-gray-400">No ARP probes observed yet.</p>';
                // }

                // Update IDS Alerts List (show most recent alerts first)
                const idsAlertsList = document.getElementById('ids-alerts-list');
                idsAlertsList.innerHTML = ''; // Clear existing list
                if (data.ids_alerts.length > 0) {
                    // Reverse to show most recent alerts first
                    data.ids_alerts.slice().reverse().forEach(alert => {
                        const li = document.createElement('li');
                        let severityClass = '';
                        switch (alert.severity) {
                            case 'CRITICAL': severityClass = 'alert-critical'; break;
                            case 'HIGH': severityClass = 'alert-high'; break;
                            case 'MEDIUM': severityClass = 'alert-medium'; break;
                            case 'LOW': severityClass = 'alert-low'; break;
                            default: severityClass = 'alert-info'; break;
                        }
                        li.className = `py-2 px-3 mb-2 rounded-md shadow-sm ${severityClass} text-white`;
                        li.innerHTML = `
                            <span class="font-bold">[${alert.severity}]</span>
                            <span class="font-medium">${formatTimestamp(alert.timestamp)}</span>:
                            ${alert.description} (Rule: ${alert.rule})
                            ${alert.source_ip ? `<br><span class="text-sm opacity-80 pl-4">Source: ${alert.source_ip} (${alert.source_mac})</span>` : ''}
                        `;
                        idsAlertsList.appendChild(li);
                    });
                    // Update Threat Level based on highest severity alert
                    const highestSeverity = data.ids_alerts.reduce((maxSev, alert) => {
                        const severities = {'LOW': 0, 'MEDIUM': 1, 'HIGH': 2, 'CRITICAL': 3, 'INFO': -1};
                        return severities[alert.severity] > severities[maxSev] ? alert.severity : maxSev;
                    }, 'INFO');
                    const threatLevelElement = document.getElementById('threat-level');
                    threatLevelElement.className = `inline-block px-6 py-2 rounded-full text-xl font-bold uppercase shadow-lg text-white `;
                    switch (highestSeverity) {
                        case 'CRITICAL': threatLevelElement.classList.add('bg-red-700'); threatLevelElement.innerText = 'CRITICAL (Xenos Incursion!)'; break;
                        case 'HIGH': threatLevelElement.classList.add('bg-orange-600'); threatLevelElement.innerText = 'HIGH (Anomaly Detected)'; break;
                        case 'MEDIUM': threatLevelElement.classList.add('bg-yellow-500'); threatLevelElement.innerText = 'MEDIUM (Minor Anomaly)'; break;
                        case 'LOW': threatLevelElement.classList.add('bg-green-500'); threatLevelElement.innerText = 'LOW (Minor Anomaly)'; break;
                        default: threatLevelElement.classList.add('bg-green-600'); threatLevelElement.innerText = 'All Clear (Machine Spirit Cohesion)'; break;
                    }

                } else {
                    idsAlertsList.innerHTML = '<p class="text-gray-400">No Heresy detected. Machine Spirit remains uncorrupted.</p>';
                    document.getElementById('threat-level').className = 'inline-block px-6 py-2 rounded-full text-xl font-bold uppercase shadow-lg bg-green-600 text-white';
                    document.getElementById('threat-level').innerText = 'All Clear (Machine Spirit Cohesion)';
                }


            } catch (error) {
                console.error("Failed to fetch data:", error);
                // Optionally update threat level to indicate comms issue
                document.getElementById('threat-level').className = 'inline-block px-6 py-2 rounded-full text-xl font-bold uppercase shadow-lg bg-gray-500 text-white';
                document.getElementById('threat-level').innerText = 'COMMUNICATION ERROR';
            }
        }

        // Initial data load
        updateData();
        // Set interval to update data every 5 seconds (adjust as needed)
        setInterval(updateData, 5000); // Update every 5 seconds
    </script>
</body>
</html>
